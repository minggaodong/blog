# TCP 可靠传输原理
## 概述
TCP 是传输层的协议，全称是叫做 Transmission Control Protocol。

### TCP 特点
- 面向连接：在数据传输之前，通信双方需要先建立一个可信的连接。
- 可靠传输：通过 ”ack 确认“和”超时重传“两种机制，保证消息的可靠送达。
- 流式传输：传输的数据不关心应用层的消息边界。
- 全双工：数据同时在两个方向上传输。

## TCP 数据包
#### TCP 的报文格式如下

![tcp_data](images/tcp_data.png)

#### 源端口
源端口表明发送端所使用的端口号，用于目标主机回应。

#### 目的端口
表明要连接的目标主机的端口号。

#### 序号
表明发送的数据包的顺序，一般为上次发送包中的顺序号+1，第一个 SYN 包的序号值是随机生成的。

#### 确认号
表明本端 TCP 已经接收到的数据，其值表示期待对端发送的下一个字节的序号，第一个 SYN 包的确认号一般为 0。

#### 数据偏移
表示 4 字节为单位的 TCP 报文的包头长度，用于确定用户数据区的起始位置。TCP 头部的大小为 20 字节，对应该值为 5。

#### 紧急标志位(URG)
开启时表明此数据包处于紧急状态应该优先处理

#### 确认标志位(ACK)
开启时表明确认号有效，否则忽略确认号

#### 推送标志位(PSH)
开启时表明应该尽快交付给应用进程，而不必等到缓存区填满才推送。

#### 复位标志位(RST)
开启时表明TCP连接出现错误，数据包非法拒绝连接。

#### 同步标志位(SYN)
建立连接的标志

#### 终止标志位(FIN)
开启时表明释放一个连接

#### 窗口大小
表明期望接受到的数据包字节数，用于拥塞控制。

#### 校验和
实现对TCP报文头以及数据区进行校验。

## TCP 工作流程
![tcp_conn](images/tcp_conn.jpg)

### 三次握手
三次握手的过程是，通信双方互相告知确认自己发送数据的序列号起始值（随机产生），序列号用来标识已发送的数据。

如果只是两次握手，至多只有连接发起方的起始序列号能被确认， 另一方选择的序列号则得不到确认。

#### 半连接队列
服务端收到 SYN 消息后进入 SYN-RECV 状态并等待客户端 ACK，此时连接为半连接，会写入服务端的半连接队列。

```
// 设置半连接队列的默认长度
echo 4096 > /proc/sys/net/ipv4/tcp_max_syn_backlog
```

#### syn flood 攻击
利用 TCP 三次握手的漏洞，短时间内向服务端发送大量 SYN 包而不响应，那么服务器的半连接队列很快会被写满，导致无法工作。

实现 syn flood 的手段，可以通过伪造源 IP 的方式，这样服务器的响应就永远到达不了客户端（握手无法完成）。

对 syn flood 实现拦截是比较困难的，最好的办法是通过专业的防火墙来解决。

#### 全连接队列
当服务端收到客户端的 ACK 后，连接建立，半连接会变成全连接，并转移到全连接队列中，对于全连接队列，如果服务器未能及时通过 accept 调用将其中的连接取走，会导致队列溢出。

全连接队列的长度会限制服务器的并发，队列的长度通过内核配置和 listen 时 backlog 参数设置，取二者的最小值，默认 1024、
```
// 内核设置
echo 4096 > /proc/sys/net/core/somaxconn
```

### 四次挥手
在连接关闭时，由于 TCP 是全双工的，通信双方需要根据业务逻辑分别关闭各自发送端，所以需要四次挥手。

#### 半关闭状态
客户端调用 close 关闭了发送通道，而服务端没有调用 close 关闭连接，这种状态就称之为半关闭。

服务端 CLOSE_WAIT 连接状态过多，说明半关闭连接多，原因是服务端可能出现了连接泄露 BUG，或者压力过大，来不及 close()。

#### TIME_WAIT 状态

