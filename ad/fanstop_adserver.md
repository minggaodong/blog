# 粉丝头条广告技术架构
## 前言
粉丝头条是微博面向 C 端用户提供的博文推广服务，用户在客户端创建推广计划并付费，目标博文会以粉丝头条的形式投放推广。

粉丝头条的目标受众包括自己的粉丝，以及推广给更多其他用户，营销目标分为增长粉丝、增加互动（转发、评论、点赞）。

粉丝头条广告的特点：
- 面向 C 端用户
- 定价保量
- 侧重效果
- 小订单多

## 系统架构
### 广告整体架构
<img src="images/fanstop_system.png" alt="" width="808" height="540" align="bottom" />

#### BP投放
提供用户直接操作的界面，可以选择订单的预算量，定向条件，营销目标等。

#### Idx
流量分发引擎，它负责将用户流量根据售卖规则并行分发给不同产品线引擎，并对各个产品线返回的结果进行简单排序后返回。

#### 超粉引擎
面向 B 端用户的广告投放引擎，提供更精细化的投放和报表服务。

#### 结算服务
实时计费服务，接收端上的真实曝光和互动数据并进行实时扣费，预算耗尽时，对计划进行下线操作。

### 粉条投放引擎架构
<img src="images/fanstop_inner.png" alt="" width="473" height="491" align="bottom" />

#### 多路召回
召回阶段相当于海选，多路召回对应多种召回策略，可以保证召回的多样性，尽量不漏掉任何一个潜在的高质量候选。

##### 定向索引
面向使用人群定向的订单，根据广告主对广告设定的定向条件，过滤出符合本次请求特点的广告，采用 BitMap 构建。

##### 智能召回
面向智能优选的订单，采用轻量级的 wide&deep 模型，只选用少量关键特征，deep 部分使用浅层的神经网络，保证模型简单快速。

##### 向量召回
面向智能优选的订单，采用 DSSM 双塔模型训练用户向量和广告向量，通过求内积来计算用户和广告的相关度。

### 过滤
过滤模块会在不同维度上，对不太符合要求的订单进行过滤。

过滤模块相当于粗排阶段，把候选数尽可能缩减到一个比较小的范围（不超过 100），减轻精排阶段的性能压力。

#### 频次过滤
针对同一个用户，保证三天内不能看到重复的广告。

频控时使用真实曝光数据（3天内不能重复），还要使用接口曝光数据（3个小时不能重复），防止端上曝光上报延迟导致频控失效。

#### 负反馈过滤
根据负反馈信息，过滤掉用户不喜欢的广告分类。

#### 平滑控制
基于 pacing 算法，对广告订单进行过滤，使广告尽量曝光给那些相关性较高的高质量用户。

### 排序
采用更多的特征，更复杂的模型（dnn）进行点击率预估计算，并计算出 eCPM， 进行排序。

### 展示控制
实现广告位的填充逻辑，一次请求一般会包含多个广告位，填充时要考虑优先级和打底逻辑。

## 技术实现
### 服务框架


## 分布式服务治理

