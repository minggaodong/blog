# 广告预算控制(Budget Pacing)算法实践

## 背景

### 问题分析
广告在投放过程中，通常采用竞价的方式来竞争一次曝光机会，对于预算有限的中小广告主来说，预算往往在初期就消耗完了，早早退出后续流量的竞争，无法触达更多优质的流量。

对广告系统来说，广告竞争集中在初期，导致后期竞争又不足，很多优质流量白白浪费掉。

广告系统自身的延迟会导致广告在预算耗尽和下线之间存在一个超投期，会导致预算超投。

### 预算控制
预算控制(Budget Pacing)的作用就是平滑消耗广告主的预算，将投放周期尽量的拉长，这样做的意义是：
- 广告可以触达更多优质流量，有机会提高广告主的ROI。
- 广告投放速度变慢，预算超投会大大降低。

## 算法实现

### 时间分段
将一个自然天按照分钟为单位进行分段，pacing模块按照时段对广告投放速度进行周期性调整。

### 流量趋势
根据历史7天的平均流量，统计出各个时段下的流量分布趋势。

预算控制的目标就是，使每个广告在任意时段下的消耗趋势，尽可能和大盘的流量趋势相接近。

### 期望消耗
假设大盘当日流量为F，截止到时段t的累积流量为F(t)； 广告A的日预算为B，则时段t的期望消耗S为：

```
S(t) = F(t) / F * B
```

在时段t下，如果实际消耗S'(t) > 期望消耗S(t)，则投放过快，需降低投放速度；反之则投放过慢，需提高投放速度。


### 投放速度控制
根据ctr来控制投放速度，ctr是点击率模型预测的得分，基于ctr的高低来控制投放速度，符合优质流量筛选的思路，可以有效提高广告主的ROI。

pacing模块为每个广告维护一个ctr阈值，预算控制时，只有当ctr得分大于对应阈值时才投放。

pacing模块周期性的计算广告实际消耗与期望消耗间的误差，基于误差调整广告的ctr阈值。所以pacing算法的本质就变成通过周期性调整ctr阈值来控制投放速度。

### 阈值调整公式
计算实际消耗和期望消耗的误差E，E的取值范围为\[0, 1\]
```
if S'(t) > S(t)
  E(t) = 1 - S'(t) / S(t)
else
  E(t) = 1 - S(t) / S'(t)
```
将误差非线性化，得到调整速率R，R的取值范围为\[0, 1\)
```
R(t) = 1 - exp(-E(t))
```
使用调整速率更新ctr阈值T
```
if S'(t) > S(t)
  T(t) = T(t-1) * (1 - R)
else
  T(t) = T(t-1) * (1 + R)
```

## 优化细节
### 冷启动
广告在首次投放时，需要设置一个初始阈值，这里增加一个冷启动环节，冷启动用于采集分析该广告的个性化ctr分布，最终设置一个初始阈值。

在冷启动期间，广告不能被投放，只负责对ctr得分进行采样，当采样数目足够多时，对ctr值样本从高到底排序，并按比例选取第Top-N的值作为初始阈值。

### 快速结束
预算控制可能会导致广告出现慢投放，导致在投放截止时不能花光预算，造成收入损失。

快速结束是预算控制下的一种保护机制，在广告投放的最后两个小时，放开预算控制，尽量的消耗掉预算。





