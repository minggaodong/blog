#### 一. 平滑的意义
* 减少因系统延迟导致的订单超投。
* 避免预算在投放初期耗尽，无法触及更多更有价值的用户。
* 有机会提高投放的转化效果。


#### 二. 投放方式对比
###### 正常投放
![image](/uploads/38bf0779b72c19e6ac96f2a907da8cc6/image.png)

###### 平滑投放
![image](/uploads/771ae34ea2ac01bdf7701fcd129a92b7/image.png)

#### 三. 平滑策略设计
###### 划分时段UV
* 将1天(0:00~24:00)按每10分钟划分时段，共划分出144个时段。
* 根据历史UV曲线，计算出每个时段的UV。

###### 制定消耗计划
* 在订单投放周期内，将购买量根据各个时段的UV数量按比例进行平铺，得到每个时段的消耗计划。
* 如果上一个时段出现多投或者少投，则计算出差值，并将差值滚动到下一个时段的消耗计划中。

###### 阈值管理
* 每个订单维护一个ctr阈值，对订单是否在当前UV下投放进行控制。每间隔30秒根据订单完成情况调整一次阈值。
* 阈值调整原则：完成量大于计划量，提升阈值；完成量低于计划量，降低阈值。
* 调整策略：从redis查询出订单的当前完成量，并计算误差E = (完成量 - 计划量)/计划量。然后根据阈值计算公式求出新的阈值。
* 计算公式：Ctr(t) = Ctr(t-1) * (1 + R)；其中t为时段，R为调整比例，当完成量低于计划消耗时R取负值，调整比例R = 1 - e^(-|E|)，其中E为误差。

###### 点击率得分采样
* 针对每个订单进行周期性采样，周期为5分钟，采样数为2万，采样完成后，会为当前订单计算出ctr阈值的上限和下限。
* 阈值的上限和下限用来控制阈值调整的范围，使阈值在固定区间内浮动，防止阈值动态调整中出现一些极端导致投放异常。
* 将采样到的ctr得分从高到底进行排序，并根据配置将前4%求平均得到阈值上限，前40%求平均得到阈值的下限。

###### 订单慢启动
* 订单刚开始投放时，没有初始阈值，此时需要先进行点击率分值采样，得到阈值的上下限，然后用阈值的上限作为初始阈值。
* 订单第一次采样过程中，不进行投放，只有得到初始化阈值后，才按初始化阈值进行投放，保证慢启动，防止小订单出现超投。

###### 快速结束
* 平滑策略有可能会导致订单预算不能完成，需要加入快速结束策略。
* 当投放至最后1/5时段，此时订单仍然没有完成，则进入快速结束模式，此时平滑策略不生效，保证订单尽快完成。

