# 广告预算控制(Budget Pacing)算法实践

## 背景

### 问题分析
广告在投放过程中，通常采用竞价的方式来竞争一次曝光，对于预算有限的中小广告主来说，预算往往在初期就被耗尽，无法参与后续的流量竞争，投放体验较差。

对广告系统来说，广告竞争集中在初期，导致后期竞争不足，很多优质流量白白浪费掉。

广告系统自身延迟会导致广告在预算耗尽和下线之间存在一个超投期，会导致预算超投。

### 预算控制
预算控制(Budget Pacing)的作用就是平滑消耗广告主的预算，这样做的意义是
- 广告的投放周期变长，广告主的投放体验得到提升。
- 广告可以触达更多优质流量，有机会提高广告主的ROI。
- 广告投放速度变慢，预算超投会大大降低。

## 算法实现
具体实现参考了Linkedin 2014年发布的论文
[Linkedin预算控制算法](linkedin预算控制算法论文.pdf)

### 时间分段
将一个自然天按照分钟为单位进行分段，pacing模块按时段对广告投放速度进行周期性调整。

### 流量趋势
根据历史7天的平均流量，统计出各个时段下的流量分布趋势。

预算控制的目标是，使每个广告在任意时段下的消耗趋势，尽可能和大盘的流量趋势相接近。

### 期望消耗
假设大盘当日流量为F，截止到时段t的累积流量为F(t)； 广告A的日预算为B，则时段t的期望消耗S为：

```
S(t) = F(t) / F * B
```

在时段t下，如果实际消耗S'(t) > 期望消耗S(t)，则投放过快，需降低投放速度；反之则投放过慢，需提高投放速度。


### 投放速度控制
根据ctr来控制投放速度，ctr是点击率模型预测的得分，基于ctr的高低来控制投放速度，符合按转化效果筛选流量的思路，可有效提高广告主的ROI。

pacing模块为每个广告维护一个ctr阈值，并规定只有当ctr得分大于阈值时才允许投放。

pacing模块周期性的计算广告实际消耗与期望消耗间的误差，基于误差调整广告的ctr阈值。所以pacing算法的本质就变成根据消耗误差周期性调整ctr阈值来控制投放速度。

### 阈值调整公式
计算实际消耗和期望消耗的误差E，E的取值范围为\[0, 1\]
```
if S'(t) > S(t)
  E(t) = 1 - S'(t) / S(t)
else
  E(t) = 1 - S(t) / S'(t)
```
将误差非线性化，得到调整速率R，R的取值范围为\[0, 1\)
```
R(t) = 1 - exp(-E(t))
```
使用调整速率更新ctr阈值T
```
if S'(t) > S(t)
  T(t) = T(t-1) * (1 - R)
else
  T(t) = T(t-1) * (1 + R)
```

## 算法优化

### 冷启动
广告在投放前，需要设置一个ctr初始阈值，这里增加一个冷启动环节，用于采集计算初始阈值。冷启动期间，广告未初始化完成，不能被投放。

对广告的ctr得分作为样本进行采集，当样本数量达到要求时，对样本值从高到底排序，按比例选取第N个值作为该广告的初始阈值。

初始阈值要设置的高一点，使得广告以一个比较慢的投放速度开始，防止超投出现。

### 快速结束
预算控制可能会导致广告在投放截止时不能花光预算，造成收入损失。

快速结束是一种防护机制，在广告投放周期内的最后两个小时开启，此时停止预算控制，让广告尽快的投放出去，完成预算。

### 阈值上下限
某个时间点，如果竞争太激烈，会导致某些广告很难投放出去，造成消耗误差越来越大，ctr阈值也被调整的越来越低，当后面某刻竞争突然少了，之前投不出的广告就会被大量的投放。

某个时间点，如果竞争很少，某些广告得到了大量投放，ctr阈值也被调整的越来越高，很多ctr高的优质的流量也被丢弃，当后面某刻竞争突然变多，这些广告不会再有机会获得之前丢弃的优质流量。

给ctr阈值设置上下限，就是为了避免上面两种场景下导致的投放波动异常。


